<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.datastreams.gpt.error.mapper.ErrorReportSaveMapper">

    <!-- L-023: 오류 보고/오류 선택지 목록 저장 -->
    <select id="saveErrorReport" parameterType="com.datastreams.gpt.error.dto.ErrorReportSaveRequestDto" resultType="java.util.Map">
        WITH ETL_DAT
        AS
        (
            SELECT
                   1              AS CNVS_ID       /* {CNVS_ID} 대화 ID */
                 , #{usrId}       AS USR_ID        /* 로그인 사용자 아이디 */
                 , #{errRptTxt}   AS ERR_RPT_TXT  /* 오류 보고 텍스트 */
            WHERE 1=1
        ), ERR_CD_LST
        AS
        (
            /* SQLMAP XML 에서 리스트를 UNION ALL 문으로 변경 함.  */
            <foreach collection="errRptCdList" item="errRptCd" separator=" UNION ALL ">
                SELECT #{errRptCd} AS ERR_RPT_CD /* UI 에서 선택한 오류 보고 코드 */
            </foreach>
        )
        , INS_USR_ERR_RPT
        AS
        (
            INSERT INTO USR_ERR_RPT
            (
                CNVS_ID
              , ERR_RPT_TXT
              , REG_USR_ID
            )
            SELECT T.CNVS_ID
                 , T.ERR_RPT_TXT
                 , T.USR_ID AS REG_USR_ID
            FROM ETL_DAT T
            WHERE 1=1
            RETURNING USR_ERR_RPT.ERR_RPT_ID, USR_ERR_RPT.REG_USR_ID
        ), INS_USR_ERR_RPT_SEL_LST
        AS
        (
            INSERT INTO USR_ERR_RPT_SEL_LST
            (
                ERR_RPT_ID
              , ERR_RPT_CD
              , REG_USR_ID
            )
            SELECT R.ERR_RPT_ID
                 , E.ERR_RPT_CD
                 , R.REG_USR_ID
            FROM INS_USR_ERR_RPT R
            INNER JOIN ERR_CD_LST E ON 1=1
            WHERE 1=1
            RETURNING USR_ERR_RPT_SEL_LST.*
        )
        SELECT 'INS_USR_ERR_RPT' AS TXN_NM, COUNT(*) AS CNT FROM INS_USR_ERR_RPT
        UNION ALL
        SELECT 'INS_USR_ERR_RPT_SEL_LST' AS TXN_NM, COUNT(*) AS CNT FROM INS_USR_ERR_RPT_SEL_LST
    </select>

    <!-- 저장된 오류 보고 코드 목록 조회 -->
    <select id="selectSavedErrorReportCodes" resultType="String">
        SELECT UESL.ERR_RPT_CD
        FROM USR_ERR_RPT UER
        INNER JOIN USR_ERR_RPT_SEL_LST UESL ON UER.ERR_RPT_ID = UESL.ERR_RPT_ID
        WHERE UER.CNVS_ID = #{cnvsId}
        AND UER.REG_USR_ID = #{usrId}
        ORDER BY UESL.ERR_RPT_CD
    </select>

</mapper>

#!/bin/bash
##############################################################################
# Admin UI ë°°í¬ ìŠ¤í¬ë¦½íŠ¸
# ìš©ë„: React Admin ì•±ì„ /var/www/html/admin/ì— ë°°í¬
# ê²½ë¡œ: https://ui.datastreams.co.kr:20443/admin/
##############################################################################

set -e  # ì—ëŸ¬ ë°œìƒ ì‹œ ì¤‘ë‹¨

echo "=========================================================================="
echo "ğŸš€ Admin UI ë°°í¬ ì‹œì‘"
echo "=========================================================================="
echo ""

# 1. ë¹Œë“œ ì‹¤í–‰
echo "ğŸ“‹ Step 1: ë¹Œë“œ"
bash /home/aigen/admin-api/scripts/build-admin-ui.sh

# 2. ë°°í¬ ë””ë ‰í† ë¦¬ í™•ì¸
DEPLOY_DIR="/var/www/html/admin"
echo ""
echo "=========================================================================="
echo "ğŸ“‹ Step 2: ë°°í¬ ë””ë ‰í† ë¦¬ ì •ë¦¬"
echo "=========================================================================="
echo ""
echo "ë°°í¬ ìœ„ì¹˜: $DEPLOY_DIR"

# ë°°í¬ ë””ë ‰í† ë¦¬ ì¡´ì¬ í™•ì¸
if [ ! -d "$DEPLOY_DIR" ]; then
    echo "âš ï¸ ë°°í¬ ë””ë ‰í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤. ìƒì„± ì¤‘..."
    mkdir -p "$DEPLOY_DIR"
fi

# ê¸°ì¡´ íŒŒì¼ ë°±ì—… (ì˜µì…˜)
BACKUP_DIR="/tmp/admin-ui-backup-$(date +%Y%m%d-%H%M%S)"
if [ "$(ls -A $DEPLOY_DIR)" ]; then
    echo "ğŸ’¾ ê¸°ì¡´ íŒŒì¼ ë°±ì—… ì¤‘: $BACKUP_DIR"
    mkdir -p "$BACKUP_DIR"
    cp -r "$DEPLOY_DIR"/* "$BACKUP_DIR/" 2>/dev/null || true
fi

# ê¸°ì¡´ íŒŒì¼ ì‚­ì œ
echo "ğŸ—‘ï¸ ê¸°ì¡´ íŒŒì¼ ì‚­ì œ ì¤‘..."
rm -rf "$DEPLOY_DIR"/*

# 3. íŒŒì¼ ë³µì‚¬
echo ""
echo "=========================================================================="
echo "ğŸ“‹ Step 3: íŒŒì¼ ë³µì‚¬"
echo "=========================================================================="
echo ""
cp -r /home/aigen/admin-api/admin-ui/dist/* "$DEPLOY_DIR/"
echo "âœ… íŒŒì¼ ë³µì‚¬ ì™„ë£Œ"

# 4. ê¶Œí•œ ì„¤ì •
echo ""
echo "ğŸ“‹ Step 4: ê¶Œí•œ ì„¤ì •"
chmod -R 755 "$DEPLOY_DIR"
echo "âœ… ê¶Œí•œ ì„¤ì • ì™„ë£Œ"

# 5. ë°°í¬ ê²°ê³¼ í™•ì¸
echo ""
echo "=========================================================================="
echo "ğŸ“‹ Step 5: ë°°í¬ ê²°ê³¼ í™•ì¸"
echo "=========================================================================="
echo ""
echo "ğŸ“¦ ë°°í¬ëœ íŒŒì¼:"
ls -lah "$DEPLOY_DIR/"
echo ""
echo "ğŸ“„ JavaScript íŒŒì¼:"
ls -lah "$DEPLOY_DIR/assets/"*.js 2>/dev/null || echo "JS íŒŒì¼ ì—†ìŒ"
echo ""
echo "ğŸ¨ CSS íŒŒì¼:"
ls -lah "$DEPLOY_DIR/assets/"*.css 2>/dev/null || echo "CSS íŒŒì¼ ì—†ìŒ"
echo ""

# 6. index.html ë‚´ìš© í™•ì¸
echo "ğŸ“„ index.html:"
cat "$DEPLOY_DIR/index.html"
echo ""

echo "=========================================================================="
echo "âœ… ë°°í¬ ì™„ë£Œ!"
echo "=========================================================================="
echo ""
echo "ğŸŒ ì ‘ì† URL: https://ui.datastreams.co.kr:20443/admin/"
echo "ğŸ’¾ ë°±ì—… ìœ„ì¹˜: $BACKUP_DIR"
echo ""
echo "âš ï¸ ë¸Œë¼ìš°ì €ì—ì„œ Ctrl+F5ë¡œ ê°•ì œ ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”."
echo "=========================================================================="

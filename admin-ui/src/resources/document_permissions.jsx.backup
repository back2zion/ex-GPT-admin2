/**
 * ë¬¸ì„œ ê¶Œí•œ ê´€ë¦¬ ë¦¬ì†ŒìŠ¤
 * PRD P0: ë¬¸ì„œ ê¶Œí•œ ê´€ë¦¬ - ë¶€ì„œë³„/ê²°ì¬ë¼ì¸ë³„ ê¶Œí•œ
 *
 * Security:
 * - XSS ë°©ì§€: react-adminì˜ ìë™ sanitization
 * - CSRF ë°©ì§€: dataProviderì—ì„œ ì²˜ë¦¬
 */

import {
    List,
    Datagrid,
    TextField,
    BooleanField,
    DateField,
    Show,
    SimpleShowLayout,
    Edit,
    Create,
    SimpleForm,
    ReferenceField,
    ReferenceInput,
    SelectInput,
    BooleanInput,
    required,
    DeleteButton,
    EditButton,
    ShowButton,
    CreateButton,
    TopToolbar,
    FilterButton,
    ExportButton,
    useRecordContext
} from 'react-admin';
import { Chip, Paper, Grid, Typography, Box } from '@mui/material';

// ============================================
// ë¬¸ì„œ ê¶Œí•œ ëª©ë¡
// ============================================

const DocumentPermissionListActions = () => (
    <TopToolbar>
        <FilterButton />
        <CreateButton label="ê¶Œí•œ ì¶”ê°€" />
        <ExportButton />
    </TopToolbar>
);

const documentPermissionFilters = [
    <ReferenceInput key="document_id" source="document_id" reference="documents" label="ë¬¸ì„œ">
        <SelectInput optionText="title" />
    </ReferenceInput>,
    <ReferenceInput key="department_id" source="department_id" reference="departments" label="ë¶€ì„œ">
        <SelectInput optionText="name" />
    </ReferenceInput>,
];

// Empty state component
const EmptyDocumentPermissionList = () => (
    <Box
        sx={{
            textAlign: 'center',
            py: 8,
            px: 3,
        }}
    >
        <Typography variant="h4" sx={{ fontSize: 80, mb: 2 }}>
            ğŸ”
        </Typography>
        <Typography variant="h5" gutterBottom sx={{ fontWeight: 'bold', color: 'text.secondary' }}>
            ì•„ì§ ë¬¸ì„œ ê¶Œí•œì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤
        </Typography>
        <Typography variant="body1" color="text.secondary" sx={{ mb: 4 }}>
            ë¶€ì„œ ë˜ëŠ” ê²°ì¬ë¼ì¸ì— ëŒ€í•œ ë¬¸ì„œ ì ‘ê·¼ ê¶Œí•œì„ ì„¤ì •í•´ë³´ì„¸ìš”.
        </Typography>
        <CreateButton label="ì²« ê¶Œí•œ ì„¤ì •í•˜ê¸°" />
    </Box>
);

// Custom field for permission target (department or approval line)
const PermissionTargetField = () => {
    const record = useRecordContext();
    if (!record) return null;

    if (record.department_id) {
        return (
            <ReferenceField source="department_id" reference="departments" link="show">
                <TextField source="name" />
            </ReferenceField>
        );
    } else if (record.approval_line_id) {
        return (
            <ReferenceField source="approval_line_id" reference="approval-lines" link="show">
                <TextField source="name" />
            </ReferenceField>
        );
    }
    return <span>-</span>;
};

// Custom field for permission summary
const PermissionSummaryField = () => {
    const record = useRecordContext();
    if (!record) return null;

    const permissions = [];
    if (record.can_read) permissions.push('ì½ê¸°');
    if (record.can_write) permissions.push('ì“°ê¸°');
    if (record.can_delete) permissions.push('ì‚­ì œ');

    return (
        <div style={{ display: 'flex', gap: '4px' }}>
            {permissions.map(perm => (
                <Chip
                    key={perm}
                    label={perm}
                    size="small"
                    color={perm === 'ì½ê¸°' ? 'success' : perm === 'ì“°ê¸°' ? 'warning' : 'error'}
                />
            ))}
        </div>
    );
};

export const DocumentPermissionList = () => (
    <List
        filters={documentPermissionFilters}
        actions={<DocumentPermissionListActions />}
        sort={{ field: 'document_id', order: 'ASC' }}
        perPage={50}
        title="ë¬¸ì„œ ê¶Œí•œ ê´€ë¦¬"
        empty={<EmptyDocumentPermissionList />}
    >
        <Datagrid
            rowClick="show"
            bulkActionButtons={false}
            sx={{
                '& .RaDatagrid-table': {
                    tableLayout: 'fixed',
                    width: '100%'
                },
                '& .RaDatagrid-headerCell': {
                    backgroundColor: '#0a2986',
                    color: 'white',
                    fontWeight: 'bold'
                },
                '& .RaDatagrid-row:hover': {
                    backgroundColor: '#f8f8f8'
                }
            }}
        >
            <TextField source="id" label="ID" sortable={false} sx={{ width: '70px' }} />
            <ReferenceField source="document_id" reference="documents" label="ë¬¸ì„œ" link="show" sx={{ width: '250px' }}>
                <TextField source="title" />
            </ReferenceField>
            <PermissionTargetField label="ê¶Œí•œ ëŒ€ìƒ" sx={{ width: '200px' }} />
            <PermissionSummaryField label="ê¶Œí•œ" sx={{ width: '220px' }} />
            <DateField source="created_at" label="ìƒì„±ì¼" showTime sx={{ width: '180px' }} />
            <ShowButton label="ìƒì„¸" sx={{ width: '80px' }} />
            <EditButton label="ìˆ˜ì •" sx={{ width: '80px' }} />
            <DeleteButton label="ì‚­ì œ" sx={{ width: '80px' }} />
        </Datagrid>
    </List>
);

// ============================================
// ë¬¸ì„œ ê¶Œí•œ ìƒì„¸
// ============================================

const DocumentPermissionShowContent = () => {
    const record = useRecordContext();
    if (!record) return null;

    return (
        <Box sx={{ width: '100%', maxWidth: 1200 }}>
            <Typography variant="h6" gutterBottom sx={{ mt: 2, mb: 2 }}>
                ğŸ“„ ë¬¸ì„œ ì •ë³´
            </Typography>
            <Paper elevation={2} sx={{ mb: 3, p: 3, backgroundColor: '#f8f9fa' }}>
                <Grid container spacing={3}>
                    <Grid item xs={12} sm={6} md={3}>
                        <Typography variant="caption" color="text.secondary">
                            ê¶Œí•œ ID
                        </Typography>
                        <Box sx={{ mt: 1 }}>
                            <TextField source="id" />
                        </Box>
                    </Grid>
                    <Grid item xs={12} sm={6} md={9}>
                        <Typography variant="caption" color="text.secondary">
                            ë¬¸ì„œ
                        </Typography>
                        <Box sx={{ mt: 1 }}>
                            <Typography variant="h6" color="primary">
                                <ReferenceField source="document_id" reference="documents" label="ë¬¸ì„œ" link="show">
                                    <TextField source="title" />
                                </ReferenceField>
                            </Typography>
                        </Box>
                    </Grid>
                </Grid>
            </Paper>

            <Typography variant="h6" gutterBottom sx={{ mt: 3, mb: 2 }}>
                ğŸ‘¥ ê¶Œí•œ ëŒ€ìƒ
            </Typography>
            <Paper elevation={2} sx={{ mb: 3, p: 3, backgroundColor: '#fff9e6' }}>
                <Grid container spacing={2}>
                    <Grid item xs={12} sm={6}>
                        <Typography variant="caption" color="text.secondary">
                            ë¶€ì„œ
                        </Typography>
                        <Box sx={{ mt: 1 }}>
                            <ReferenceField source="department_id" reference="departments" label="ë¶€ì„œ" link="show">
                                <TextField source="name" />
                            </ReferenceField>
                        </Box>
                    </Grid>
                    <Grid item xs={12} sm={6}>
                        <Typography variant="caption" color="text.secondary">
                            ê²°ì¬ë¼ì¸
                        </Typography>
                        <Box sx={{ mt: 1 }}>
                            <ReferenceField source="approval_line_id" reference="approval-lines" label="ê²°ì¬ë¼ì¸" link="show">
                                <TextField source="name" />
                            </ReferenceField>
                        </Box>
                    </Grid>
                </Grid>
            </Paper>

            <Typography variant="h6" gutterBottom sx={{ mt: 3, mb: 2 }}>
                ğŸ” ê¶Œí•œ ì„¤ì •
            </Typography>
            <Paper elevation={2} sx={{ mb: 3, p: 3, backgroundColor: '#f0f7ff' }}>
                <Grid container spacing={3}>
                    <Grid item xs={12} sm={4}>
                        <Typography variant="caption" color="text.secondary">
                            ì½ê¸° ê¶Œí•œ
                        </Typography>
                        <Box sx={{ mt: 1 }}>
                            <BooleanField source="can_read" />
                        </Box>
                    </Grid>
                    <Grid item xs={12} sm={4}>
                        <Typography variant="caption" color="text.secondary">
                            ì“°ê¸° ê¶Œí•œ
                        </Typography>
                        <Box sx={{ mt: 1 }}>
                            <BooleanField source="can_write" />
                        </Box>
                    </Grid>
                    <Grid item xs={12} sm={4}>
                        <Typography variant="caption" color="text.secondary">
                            ì‚­ì œ ê¶Œí•œ
                        </Typography>
                        <Box sx={{ mt: 1 }}>
                            <BooleanField source="can_delete" />
                        </Box>
                    </Grid>
                </Grid>
            </Paper>

            <Typography variant="h6" gutterBottom sx={{ mt: 3, mb: 2 }}>
                ğŸ“Š ë©”íƒ€ë°ì´í„°
            </Typography>
            <Grid container spacing={2}>
                <Grid item xs={12} sm={6}>
                    <Paper elevation={1} sx={{ p: 2 }}>
                        <Typography variant="caption" color="text.secondary">
                            ìƒì„±ì¼ì‹œ
                        </Typography>
                        <Box sx={{ mt: 1 }}>
                            <DateField source="created_at" showTime />
                        </Box>
                    </Paper>
                </Grid>
                <Grid item xs={12} sm={6}>
                    <Paper elevation={1} sx={{ p: 2 }}>
                        <Typography variant="caption" color="text.secondary">
                            ìˆ˜ì •ì¼ì‹œ
                        </Typography>
                        <Box sx={{ mt: 1 }}>
                            <DateField source="updated_at" showTime />
                        </Box>
                    </Paper>
                </Grid>
            </Grid>
        </Box>
    );
};

export const DocumentPermissionShow = () => (
    <Show title="ë¬¸ì„œ ê¶Œí•œ ìƒì„¸">
        <DocumentPermissionShowContent />
    </Show>
);

// ============================================
// ë¬¸ì„œ ê¶Œí•œ ìˆ˜ì •
// ============================================

export const DocumentPermissionEdit = () => (
    <Edit title="ë¬¸ì„œ ê¶Œí•œ ìˆ˜ì •" mutationMode="pessimistic">
        <SimpleForm>
            <Box sx={{ width: '100%', maxWidth: 1200 }}>
                <Typography variant="h6" gutterBottom sx={{ mt: 2, mb: 2 }}>
                    ğŸ“„ ë¬¸ì„œ ì„ íƒ
                </Typography>
                <Paper elevation={2} sx={{ mb: 3, p: 3, backgroundColor: '#f8f9fa' }}>
                    <ReferenceInput
                        source="document_id"
                        reference="documents"
                        label="ë¬¸ì„œ"
                        validate={[required()]}
                    >
                        <SelectInput
                            optionText="title"
                            fullWidth
                            disabled
                            helperText="ìƒì„± í›„ ë³€ê²½ ë¶ˆê°€"
                        />
                    </ReferenceInput>
                </Paper>

                <Typography variant="h6" gutterBottom sx={{ mt: 3, mb: 2 }}>
                    ğŸ‘¥ ê¶Œí•œ ëŒ€ìƒ
                </Typography>
                <Paper elevation={2} sx={{ mb: 3, p: 3, backgroundColor: '#fff9e6' }}>
                    <Grid container spacing={2}>
                        <Grid item xs={12} sm={6}>
                            <ReferenceInput
                                source="department_id"
                                reference="departments"
                                label="ë¶€ì„œ (ì„ íƒ)"
                            >
                                <SelectInput
                                    optionText="name"
                                    fullWidth
                                    helperText="ë¶€ì„œ ë˜ëŠ” ê²°ì¬ë¼ì¸ ì¤‘ í•˜ë‚˜ ì„ íƒ"
                                />
                            </ReferenceInput>
                        </Grid>
                        <Grid item xs={12} sm={6}>
                            <ReferenceInput
                                source="approval_line_id"
                                reference="approval-lines"
                                label="ê²°ì¬ë¼ì¸ (ì„ íƒ)"
                            >
                                <SelectInput
                                    optionText="name"
                                    fullWidth
                                    helperText="ë¶€ì„œ ë˜ëŠ” ê²°ì¬ë¼ì¸ ì¤‘ í•˜ë‚˜ ì„ íƒ"
                                />
                            </ReferenceInput>
                        </Grid>
                    </Grid>
                </Paper>

                <Typography variant="h6" gutterBottom sx={{ mt: 3, mb: 2 }}>
                    ğŸ” ê¶Œí•œ ì„¤ì •
                </Typography>
                <Paper elevation={2} sx={{ mb: 3, p: 3, backgroundColor: '#f0f7ff' }}>
                    <Grid container spacing={2}>
                        <Grid item xs={12} sm={4}>
                            <BooleanInput
                                source="can_read"
                                label="ì½ê¸° ê¶Œí•œ"
                                defaultValue={true}
                                helperText="ë¬¸ì„œ ì¡°íšŒ ê¶Œí•œ"
                            />
                        </Grid>
                        <Grid item xs={12} sm={4}>
                            <BooleanInput
                                source="can_write"
                                label="ì“°ê¸° ê¶Œí•œ"
                                defaultValue={false}
                                helperText="ë¬¸ì„œ ìˆ˜ì • ê¶Œí•œ"
                            />
                        </Grid>
                        <Grid item xs={12} sm={4}>
                            <BooleanInput
                                source="can_delete"
                                label="ì‚­ì œ ê¶Œí•œ"
                                defaultValue={false}
                                helperText="ë¬¸ì„œ ì‚­ì œ ê¶Œí•œ"
                            />
                        </Grid>
                    </Grid>
                </Paper>
            </Box>
        </SimpleForm>
    </Edit>
);

// ============================================
// ë¬¸ì„œ ê¶Œí•œ ìƒì„±
// ============================================

export const DocumentPermissionCreate = () => (
    <Create title="ë¬¸ì„œ ê¶Œí•œ ìƒì„±" redirect="list">
        <SimpleForm
            sx={{
                '& .MuiFormControl-root': { marginBottom: '16px' }
            }}
        >
            <ReferenceInput
                source="document_id"
                reference="documents"
                label="ë¬¸ì„œ"
                validate={[required()]}
            >
                <SelectInput
                    optionText="title"
                    fullWidth
                    helperText="ê¶Œí•œì„ ë¶€ì—¬í•  ë¬¸ì„œ ì„ íƒ"
                />
            </ReferenceInput>

            <ReferenceInput
                source="department_id"
                reference="departments"
                label="ë¶€ì„œ (ì„ íƒ)"
            >
                <SelectInput
                    optionText="name"
                    fullWidth
                    helperText="ë¶€ì„œ ë˜ëŠ” ê²°ì¬ë¼ì¸ ì¤‘ í•˜ë‚˜ ì„ íƒ"
                />
            </ReferenceInput>

            <ReferenceInput
                source="approval_line_id"
                reference="approval-lines"
                label="ê²°ì¬ë¼ì¸ (ì„ íƒ)"
            >
                <SelectInput
                    optionText="name"
                    fullWidth
                    helperText="ë¶€ì„œ ë˜ëŠ” ê²°ì¬ë¼ì¸ ì¤‘ í•˜ë‚˜ ì„ íƒ"
                />
            </ReferenceInput>

            <BooleanInput
                source="can_read"
                label="ì½ê¸° ê¶Œí•œ"
                defaultValue={true}
                helperText="ë¬¸ì„œ ì¡°íšŒ ê¶Œí•œ"
            />

            <BooleanInput
                source="can_write"
                label="ì“°ê¸° ê¶Œí•œ"
                defaultValue={false}
                helperText="ë¬¸ì„œ ìˆ˜ì • ê¶Œí•œ"
            />

            <BooleanInput
                source="can_delete"
                label="ì‚­ì œ ê¶Œí•œ"
                defaultValue={false}
                helperText="ë¬¸ì„œ ì‚­ì œ ê¶Œí•œ"
            />
        </SimpleForm>
    </Create>
);

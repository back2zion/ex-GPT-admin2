services:
  # Admin API - Internal only (관리자 전용)
  admin-api:
    build: .
    ports:
      - "8010:8001"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - default
      - exgpt
    environment:
      - DATABASE_URL=postgresql+asyncpg://postgres:password@postgres:5432/admin_db
      - USER_UI_URL=http://host.docker.internal:18180/exGenBotDS/testOld
      - USER_DB_URL=postgresql+asyncpg://wisenut_main:express!12@host.docker.internal:5444/AGENAI
      - REDIS_URL=redis://redis:6379
      - CERBOS_HOST=cerbos
      - CERBOS_PORT=3592
      - MINIO_ENDPOINT=host.docker.internal:10002
      - MINIO_ACCESS_KEY=admin
      - MINIO_SECRET_KEY=admin123
      - MINIO_SECURE=false
      - MINIO_BUCKET=documents
      - QDRANT_HOST=qdrant
      - QDRANT_PORT=6333
      - QDRANT_COLLECTION=130825-512-v3
      - QDRANT_API_KEY=QFy9YlRTm0Y1yo6D
      - EMBEDDING_MODEL_ENDPOINT=http://vllm-embeddings:8000/v1
      - EX_GPT_QDRANT_HOST=qdrant
      - EX_GPT_QDRANT_PORT=6333
      - EX_GPT_QDRANT_API_KEY=QFy9YlRTm0Y1yo6D
      - EX_GPT_MINIO_ENDPOINT=minio:9000
      - MLFLOW_TRACKING_URI=http://mlflow:5000
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility
    depends_on:
      - postgres
      - redis
      - cerbos
    volumes:
      - ./app:/app/app
      - ./tests:/app/tests
      - ./frontend/dist:/app/frontend/dist:ro
      - /usr/bin/nvidia-smi:/usr/bin/nvidia-smi:ro
      - /usr/lib/libnvidia-ml.so:/usr/lib/libnvidia-ml.so:ro
      - /usr/lib/libnvidia-ml.so.1:/usr/lib/libnvidia-ml.so.1:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /usr/bin/docker:/usr/bin/docker:ro
      # STT 음성 파일 저장소 (읽기/쓰기)
      - /data/audio:/data/audio:rw
      - /data/images:/data/images:ro
      # Hugging Face 모델 캐시 (읽기 전용)
      - /home/aigen/.cache/huggingface:/home/aigen/.cache/huggingface:ro
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    command: uvicorn app.main:app --host 0.0.0.0 --port 8001 --reload

  # User API - Public only (사용자 채팅 전용)
  user-api:
    build: .
    ports:
      - "8080:8001"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - default
      - exgpt
    environment:
      - DATABASE_URL=postgresql+asyncpg://postgres:password@postgres:5432/admin_db
      - REDIS_URL=redis://redis:6379
      - LLM_API_URL=http://host.docker.internal:8000
    depends_on:
      - postgres
      - redis
    volumes:
      - ./app:/app/app
    command: uvicorn app.main_public:app --host 0.0.0.0 --port 8001 --reload

  postgres:
    image: postgres:15-alpine
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=password
      - POSTGRES_DB=admin_db
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data

  cerbos:
    image: ghcr.io/cerbos/cerbos:latest
    ports:
      - "3592:3592"
      - "3593:3593"
    volumes:
      - ./policies:/policies
    command: server --config=/policies/config.yaml

  mlflow:
    image: python:3.11-slim
    ports:
      - "5000:5000"
    environment:
      - MLFLOW_BACKEND_STORE_URI=postgresql://postgres:password@postgres:5432/mlflow_db
      - MLFLOW_ARTIFACT_ROOT=/mlflow/artifacts
    depends_on:
      - postgres
    volumes:
      - mlflow_artifacts:/mlflow/artifacts
    command: >
      sh -c "pip install mlflow psycopg2-binary &&
             mlflow server
             --backend-store-uri postgresql://postgres:password@postgres:5432/mlflow_db
             --default-artifact-root /mlflow/artifacts
             --host 0.0.0.0
             --port 5000"

networks:
  default:
    name: admin-api_default
  exgpt:
    external: true
    name: exgpt_net

volumes:
  postgres_data:
  redis_data:
  mlflow_artifacts:
